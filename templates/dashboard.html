{% extends 'base.html' %}
{% import "bootstrap/wtf.html" as wtf %}
{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard/dashboard.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.0/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.0.0/chartjs-plugin-datalabels.min.js" integrity="sha512-R/QOHLpV1Ggq22vfDAWYOaMd5RopHrJNMxi8/lJu8Oihwi4Ho4BRFeiMiCefn9rasajKjnx9/fTQ/xkWnkDACg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
{% endblock head %}

{% block page_content %}
    <div class="row">
        <div class="col-md-12 mt-5 mb-4">
            <h3 class="text-center">{{ device_name }}: Centro de monitoreo</h3>
        </div>

        <div class="col-md-6 ">
            <h4 class="text-center mb-3">
                Temperatura
            </h4>
            <div class="card">
                <div class="card-body">
                    <canvas id="temperature_gauge" width="200", height="100"></canvas> 
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <h4 class="text-center mb-3">
                Humedad
            </h4>
            <div class="card">
                <div class="card-body">
                    <canvas id="humidity_gauge" width="200", height="100"></canvas> 
                </div>
            </div>
        </div>
        
        <div class="col-md-12 mt-5">
            <form method="post">
                {{ form.csrt_token}}
                {{ form.date_from.label }} {{ form.date_from(class="datepicker") }} {{ form.hidden_tag()}} 
                {{ form.date_to.label }} {{ form.date_to(class="datepicker") }} {{ form.hidden_tag()}} 
                {{ form.submit }} 
            </form>   
            <h4 class="text-center mb-3">
                graficasdkfasfksf
            </h4>
            <div class="card">
                <div class="card-body">
                    <canvas id="humidity_temperature" width="200", height="100"></canvas> 
                </div>
            </div>
        </div>
    </div>

{% endblock page_content %}


{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='dashboard/dashboard.js') }}"></script>
    <script>

        var chartData = {
            labels : [{% for dato in data %}
                "{{ dato.date }}",
                {% endfor %}],
            datasets : [{
                label: 'Temperatura',
                fill: true,
                lineTension: 0.1,
                backgroundColor: "rgba(114,103,167,0.2)",
                borderColor: "rgba(107,76,154,1)",
                borderCapStyle: 'butt',
                borderDash: [],
                borderDashOffset: 0.0,
                borderJoinStyle: 'mister',
                pointBorderColor: "rgba(107,76,154,1)",
                pointBackgroundColor: "#fff",
                pointBorderWidth: 1,
                pointHoverRadius: 5,
                pointHoverBackgroundColor: "rgba(107,76,154,1)",
                pointHoverBorderColor: "rgba(220,220,220,1)",
                pointHoverBorderWidth: 2,
                pointRadius: 1,
                pointHitRadius: 10,
                data : [{% for dato in data %}
                        {{ dato.temperature }},
                    {% endfor %}],
                spanGaps: false
            },
            {
                label: 'Humedad',
                fill: true,
                lineTension: 0.1,
                backgroundColor: "rgba(114,103,167,0.2)",
                borderColor: "rgba(107,76,154,1)",
                borderCapStyle: 'butt',
                borderDash: [],
                borderDashOffset: 0.0,
                borderJoinStyle: 'mister',
                pointBorderColor: "rgba(107,76,154,1)",
                pointBackgroundColor: "#fff",
                pointBorderWidth: 1,
                pointHoverRadius: 5,
                pointHoverBackgroundColor: "rgba(107,76,154,1)",
                pointHoverBorderColor: "rgba(220,220,220,1)",
                pointHoverBorderWidth: 2,
                pointRadius: 1,
                pointHitRadius: 10,
                data : [{% for dato in data %}
                        {{ dato.humidity }},
                    {% endfor %}],
                spanGaps: false
            }]
        };
    console.log(chartData.datasets) 
        var ctx = document.getElementById("humidity_temperature").getContext("2d");

        var acumulados1 = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                    legend: {
                        labels: {
                            usePointStyle: false
                    }
                },
                scales: {
                    xAxes: [{
                        display: true,
                        gridLines: {
                            color: "rgba(0, 0, 0, 0)",
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Hora'
                        },
                        ticks: {
                            display: false
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Flujo de agua (L/min)'
                        }
                    }]
                },
            }
        });
        

    const source = new EventSource("/tiempo_real/{{ device_name }}");

    source.onmessage = function (event) {
        const data = JSON.parse(event.data);
        chart_temp.data.datasets[0].data = [data.temperature, 100-data.temperature];
        chart_hum.data.datasets[0].data = [data.humidity, 100-data.humidity];
        chart_temp.update();
        chart_hum.update();
    }
    </script>
{% endblock scripts %}